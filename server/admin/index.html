<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeadCapture Pro â€” Painel Administrativo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:      #0a0a0b;
      --card:    #111113;
      --raised:  #18181b;
      --border:  rgba(255,255,255,0.06);
      --brand:   #ee7b4d;
      --brand-2: #f59e42;
      --blue:    #3b82f6;
      --text:    #f4f4f5;
      --muted:   #71717a;
      --dim:     #3f3f46;
      --hot:     #ef4444;
      --warm:    #f59e0b;
      --cold:    #3b82f6;
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ TOPBAR â”€â”€â”€ */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: rgba(10,10,11,.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 28px;
      height: 60px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .topbar-logo {
      display: flex; align-items: center; gap: 10px;
    }
    .topbar-mark {
      width: 34px; height: 34px; background: var(--brand);
      border-radius: 9px; font-weight: 900; font-size: 12px;
      color: #000; display: flex; align-items: center; justify-content: center;
    }
    .topbar-name { font-weight: 700; font-size: 14px; }
    .topbar-name span { color: var(--brand); }
    .topbar-sub {
      font-size: 11px; color: var(--muted); font-weight: 500;
    }
    .topbar-badge {
      background: rgba(238,123,77,.12); border: 1px solid rgba(238,123,77,.25);
      color: var(--brand); font-size: 10px; font-weight: 700;
      padding: 3px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: .08em;
    }

    /* â”€â”€ LAYOUT â”€â”€â”€ */
    .main { max-width: 1400px; margin: 0 auto; padding: 28px 24px 80px; }

    /* â”€â”€ STATS â”€â”€â”€ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px; margin-bottom: 28px;
    }
    .stat-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px;
      transition: border-color .2s;
    }
    .stat-card:hover { border-color: rgba(238,123,77,.2); }
    .stat-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .12em; color: var(--muted); margin-bottom: 8px; }
    .stat-value { font-size: 2.2rem; font-weight: 900; letter-spacing: -1.5px; }
    .stat-value.orange { color: var(--brand); }
    .stat-value.red    { color: var(--hot);   }
    .stat-value.yellow { color: var(--warm);  }
    .stat-value.blue   { color: var(--blue);  }
    .stat-value.white  { color: var(--text);  }
    .stat-sub { font-size: 11px; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ TABS â”€â”€â”€ */
    .tabs {
      display: flex; gap: 4px; margin-bottom: 20px;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; padding: 5px;
      width: fit-content;
    }
    .tab {
      padding: 8px 20px; border-radius: 10px; font-size: 13px; font-weight: 600;
      cursor: pointer; border: none; background: none; color: var(--muted);
      transition: all .15s;
    }
    .tab.active {
      background: var(--brand); color: #000; font-weight: 700;
    }
    .tab:not(.active):hover { color: var(--text); background: rgba(255,255,255,.04); }

    /* â”€â”€ TOOLBAR â”€â”€â”€ */
    .toolbar {
      display: flex; flex-wrap: wrap; gap: 10px;
      align-items: center; margin-bottom: 16px;
    }
    .toolbar input, .toolbar select {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 9px 14px; color: var(--text);
      font-size: 13px; font-family: inherit;
      transition: border-color .2s;
    }
    .toolbar input:focus, .toolbar select:focus {
      outline: none; border-color: rgba(238,123,77,.4);
      box-shadow: 0 0 0 3px rgba(238,123,77,.1);
    }
    .toolbar input { flex: 1; min-width: 200px; }
    .toolbar select option { background: #18181b; }
    .btn-export {
      background: rgba(59,130,246,.1); border: 1px solid rgba(59,130,246,.3);
      color: var(--blue); padding: 9px 18px; border-radius: 10px;
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s;
      white-space: nowrap;
    }
    .btn-export:hover { background: rgba(59,130,246,.2); }
    .btn-refresh {
      background: rgba(238,123,77,.08); border: 1px solid rgba(238,123,77,.2);
      color: var(--brand); padding: 9px 14px; border-radius: 10px;
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all .15s;
    }
    .btn-refresh:hover { background: rgba(238,123,77,.15); }

    /* â”€â”€ TABLE â”€â”€â”€ */
    .table-wrap {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 18px; overflow: hidden;
    }
    .table-wrap table { width: 100%; border-collapse: collapse; }
    .table-wrap thead tr { border-bottom: 1px solid var(--border); }
    .table-wrap th {
      padding: 12px 16px; text-align: left;
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: .1em; color: var(--muted);
    }
    .table-wrap td { padding: 13px 16px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,.03); }
    .table-wrap tr:last-child td { border-bottom: none; }
    .table-wrap tr:hover td { background: rgba(255,255,255,.02); }

    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 700; text-transform: uppercase;
    }
    .badge-hot   { background: rgba(239,68,68,.1);  border: 1px solid rgba(239,68,68,.3);  color: #f87171; }
    .badge-warm  { background: rgba(245,158,11,.1); border: 1px solid rgba(245,158,11,.3); color: #fbbf24; }
    .badge-cold  { background: rgba(59,130,246,.1); border: 1px solid rgba(59,130,246,.3); color: #60a5fa; }
    .badge-novo       { background: rgba(255,255,255,.06); border: 1px solid var(--border); color: var(--muted); }
    .badge-convertido { background: rgba(34,197,94,.1); border: 1px solid rgba(34,197,94,.3); color: #4ade80; }
    .badge-produto { background: rgba(238,123,77,.1); border: 1px solid rgba(238,123,77,.3); color: var(--brand); }
    .badge-sistema { background: rgba(59,130,246,.1); border: 1px solid rgba(59,130,246,.3); color: var(--blue); }

    .score-bar-wrap { display: flex; align-items: center; gap: 8px; min-width: 90px; }
    .score-bar { flex: 1; height: 4px; background: rgba(255,255,255,.05); border-radius: 4px; overflow: hidden; }
    .score-fill { height: 100%; border-radius: 4px; transition: width .6s; }
    .score-num { font-size: 12px; font-weight: 700; width: 24px; text-align: right; }

    .avatar {
      width: 32px; height: 32px; border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 12px; color: #000; flex-shrink: 0;
    }
    .lead-name { font-weight: 600; color: var(--text); }
    .lead-meta { font-size: 11px; color: var(--muted); margin-top: 1px; }

    .empty-state {
      padding: 56px 24px; text-align: center; color: var(--muted);
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; opacity: .3; }
    .empty-state p { font-size: .9rem; }

    /* â”€â”€ MODAL â”€â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--raised); border: 1px solid var(--border);
      border-radius: 20px; width: 100%; max-width: 520px;
      overflow: hidden; max-height: 90vh; overflow-y: auto;
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-title { font-size: 1rem; font-weight: 700; }
    .modal-close {
      background: none; border: none; color: var(--muted); cursor: pointer;
      font-size: 18px; line-height: 1; padding: 4px;
      transition: color .15s;
    }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 24px; }
    .modal-field { margin-bottom: 16px; }
    .modal-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-bottom: 5px; }
    .modal-field-value { font-size: .9rem; color: var(--text); }

    /* â”€â”€ PAGINATION â”€â”€â”€ */
    .pagination { display: flex; gap: 6px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
    .page-btn {
      min-width: 34px; height: 34px; padding: 0 10px;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; font-size: 13px; color: var(--muted);
      cursor: pointer; transition: all .15s; font-family: inherit;
    }
    .page-btn:hover { color: var(--text); border-color: rgba(238,123,77,.3); }
    .page-btn.active { background: var(--brand); color: #000; font-weight: 700; border-color: var(--brand); }

    /* â”€â”€ FOOTER â”€â”€â”€ */
    .footer {
      text-align: center; padding: 32px 20px;
      border-top: 1px solid var(--border); margin-top: 40px;
    }
    .footer p { font-size: 11px; color: var(--dim); margin-bottom: 2px; }
    .footer strong { color: var(--muted); }
    .footer span { color: var(--brand); font-weight: 700; }

    @media(max-width: 768px) {
      .topbar { padding: 0 16px; }
      .main { padding: 20px 14px 60px; }
      .topbar-sub { display: none; }
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-logo">
      <div class="topbar-mark">LC</div>
      <div>
        <div class="topbar-name">Lead<span>Capture</span> Pro</div>
        <div class="topbar-sub">Painel Administrativo Â· ZafalÃ£o Tech</div>
      </div>
    </div>
    <div class="topbar-badge">Admin</div>
  </header>

  <div class="main">

    <!-- STATS -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Total Franquias</div>
        <div class="stat-value white" id="statTotal">â€”</div>
        <div class="stat-sub">leads produto</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Hot</div>
        <div class="stat-value red" id="statHot">â€”</div>
        <div class="stat-sub">score â‰¥ 80</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Warm</div>
        <div class="stat-value yellow" id="statWarm">â€”</div>
        <div class="stat-sub">score 60â€“79</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">LeadCapture Pro</div>
        <div class="stat-value blue" id="statSistema">â€”</div>
        <div class="stat-sub">prospects sistema</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Hoje</div>
        <div class="stat-value orange" id="statHoje">â€”</div>
        <div class="stat-sub">novos leads</div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab active" id="tabProduto" onclick="switchTab('produto')">
        ğŸ¢ Franquias / Produtos
      </button>
      <button class="tab" id="tabSistema" onclick="switchTab('sistema')">
        ğŸš€ LeadCapture Pro
      </button>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <input type="text" id="searchInput" placeholder="Buscar por nome, e-mail ou telefone...">
      <select id="categoriaFilter">
        <option value="">Todas as categorias</option>
        <option value="hot">ğŸ”¥ Hot</option>
        <option value="warm">ğŸŒ¤ Warm</option>
        <option value="cold">â„ï¸ Cold</option>
      </select>
      <select id="marcaFilter">
        <option value="">Todas as marcas</option>
      </select>
      <button class="btn-refresh" onclick="loadAll()">â†» Atualizar</button>
      <button class="btn-export" onclick="exportCSV()">â†“ Exportar CSV</button>
    </div>

    <!-- TABLE -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr id="tableHead">
            <!-- injected by JS -->
          </tr>
        </thead>
        <tbody id="leadsTable">
          <tr><td colspan="8" class="empty-state">
            <div class="icon">â³</div>
            <p>Carregando dados...</p>
          </td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" id="pagination"></div>

  </div>

  <!-- MODAL LEAD -->
  <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modalTitle">Detalhes do Lead</span>
        <button class="modal-close" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <p><strong>LeadCapture Pro</strong> â€” <span>Desenvolvido por ZafalÃ£o Tech</span></p>
    <p>ZafalÃ£o Tecnologia LTDA Â· Sistema de captaÃ§Ã£o e qualificaÃ§Ã£o de leads</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // â”€â”€ ConfiguraÃ§Ã£o Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SUPABASE_URL = 'https://krcybmownrpfjvqhacup.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyY3libW93bnJwZmp2cWhhY3VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNTM0MDgsImV4cCI6MjA4NDcyOTQwOH0.Y5D_dWds6XmJuhy0oxPwkgSmbq4BGS3sKB0OlHahP_c'
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

    // â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allLeads      = []
    let allSistema    = []
    let filtered      = []
    let currentTab    = 'produto'
    let currentPage   = 1
    const PER_PAGE    = 25

    // â”€â”€ Carregamento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAll() {
      await Promise.all([ loadLeads(), loadSistema() ])
    }

    async function loadLeads() {
      try {
        const { data, error } = await db
          .from('leads')
          .select('*, marcas(id, nome, emoji)')
          .order('created_at', { ascending: false })
        if (error) throw error
        allLeads = data || []
        updateStats()
        if (currentTab === 'produto') renderTable()
      } catch (e) {
        console.error('[Admin] leads:', e.message)
      }
    }

    async function loadSistema() {
      try {
        const { data, error } = await db
          .from('leads_sistema')
          .select('*')
          .order('created_at', { ascending: false })
        if (error) throw error
        allSistema = data || []
        document.getElementById('statSistema').textContent = allSistema.length
        if (currentTab === 'sistema') renderTable()
      } catch (e) {
        console.error('[Admin] leads_sistema:', e.message)
      }
    }

    // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateStats() {
      const today = new Date().toISOString().split('T')[0]
      const hot   = allLeads.filter(l => l.categoria === 'hot').length
      const warm  = allLeads.filter(l => l.categoria === 'warm').length
      const hoje  = allLeads.filter(l => l.created_at?.startsWith(today)).length
        + allSistema.filter(l => l.created_at?.startsWith(today)).length

      document.getElementById('statTotal').textContent = allLeads.length
      document.getElementById('statHot').textContent   = hot
      document.getElementById('statWarm').textContent  = warm
      document.getElementById('statHoje').textContent  = hoje

      // Populace marca filter
      const marcas = [...new Set(allLeads.map(l => l.marcas?.nome).filter(Boolean))].sort()
      const sel = document.getElementById('marcaFilter')
      sel.innerHTML = '<option value="">Todas as marcas</option>'
      marcas.forEach(m => {
        const o = document.createElement('option')
        o.value = o.textContent = m
        sel.appendChild(o)
      })
    }

    // â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(tab) {
      currentTab = tab
      currentPage = 1
      document.getElementById('tabProduto').classList.toggle('active', tab === 'produto')
      document.getElementById('tabSistema').classList.toggle('active', tab === 'sistema')
      document.getElementById('categoriaFilter').style.display = tab === 'produto' ? '' : 'none'
      document.getElementById('marcaFilter').style.display     = tab === 'produto' ? '' : 'none'
      renderTable()
    }

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable() {
      const search   = document.getElementById('searchInput').value.toLowerCase()
      const cat      = document.getElementById('categoriaFilter').value
      const marca    = document.getElementById('marcaFilter').value

      const source = currentTab === 'produto' ? allLeads : allSistema

      filtered = source.filter(l => {
        const s = !search ||
          l.nome?.toLowerCase().includes(search) ||
          l.email?.toLowerCase().includes(search) ||
          l.telefone?.includes(search)
        const c = !cat   || l.categoria === cat
        const m = !marca || l.marcas?.nome === marca
        return s && c && m
      })

      const head = document.getElementById('tableHead')
      const tbody = document.getElementById('leadsTable')

      if (currentTab === 'produto') {
        head.innerHTML = `
          <th>Lead</th>
          <th class="hide-sm">Contato</th>
          <th>Categoria</th>
          <th class="hide-sm">Score</th>
          <th class="hide-sm">Marca</th>
          <th class="hide-sm">Data</th>
          <th></th>
        `
      } else {
        head.innerHTML = `
          <th>Lead</th>
          <th class="hide-sm">Contato</th>
          <th class="hide-sm">Empresa</th>
          <th class="hide-sm">Local</th>
          <th>Status</th>
          <th class="hide-sm">Data</th>
          <th></th>
        `
      }

      const start = (currentPage - 1) * PER_PAGE
      const page  = filtered.slice(start, start + PER_PAGE)

      if (!page.length) {
        tbody.innerHTML = `<tr><td colspan="7">
          <div class="empty-state">
            <div class="icon">ğŸ“­</div>
            <p>Nenhum lead encontrado</p>
          </div>
        </td></tr>`
        renderPagination()
        return
      }

      tbody.innerHTML = page.map(l => {
        const initial = (l.nome || '?').charAt(0).toUpperCase()
        const date = new Date(l.created_at).toLocaleDateString('pt-BR')

        if (currentTab === 'produto') {
          const score = l.score || 0
          const barColor = score >= 80 ? '#ef4444' : score >= 60 ? '#f59e0b' : '#3b82f6'
          const catBadge = l.categoria === 'hot'
            ? '<span class="badge badge-hot">ğŸ”¥ Hot</span>'
            : l.categoria === 'warm'
            ? '<span class="badge badge-warm">ğŸŒ¤ Warm</span>'
            : '<span class="badge badge-cold">â„ï¸ Cold</span>'

          return `<tr onclick="openModal(${JSON.stringify(l).replace(/"/g,'&quot;')})">
            <td>
              <div style="display:flex;align-items:center;gap:10px">
                <div class="avatar">${initial}</div>
                <div>
                  <div class="lead-name">${l.nome || 'â€”'}</div>
                  <div class="lead-meta">${l.status || 'novo'}</div>
                </div>
              </div>
            </td>
            <td class="hide-sm">
              <div style="color:var(--muted);font-size:12px">${l.email || 'â€”'}</div>
              <div style="color:var(--dim);font-size:11px">${l.telefone || 'â€”'}</div>
            </td>
            <td>${catBadge}</td>
            <td class="hide-sm">
              <div class="score-bar-wrap">
                <div class="score-bar"><div class="score-fill" style="width:${score}%;background:${barColor}"></div></div>
                <span class="score-num" style="color:${barColor}">${score}</span>
              </div>
            </td>
            <td class="hide-sm">
              <span style="font-size:12px">${l.marcas?.emoji || ''} ${l.marcas?.nome || 'â€”'}</span>
            </td>
            <td class="hide-sm" style="color:var(--muted);font-size:12px">${date}</td>
            <td><button style="background:none;border:none;color:var(--brand);font-size:11px;font-weight:700;cursor:pointer">Ver â†’</button></td>
          </tr>`
        } else {
          return `<tr onclick="openModalSistema(${JSON.stringify(l).replace(/"/g,'&quot;')})">
            <td>
              <div style="display:flex;align-items:center;gap:10px">
                <div class="avatar" style="background:linear-gradient(135deg,#3b82f6,#8b5cf6)">${initial}</div>
                <div>
                  <div class="lead-name">${l.nome || 'â€”'}</div>
                  <div class="lead-meta">${l.email || 'â€”'}</div>
                </div>
              </div>
            </td>
            <td class="hide-sm" style="color:var(--muted);font-size:12px">${l.telefone || 'â€”'}</td>
            <td class="hide-sm" style="color:var(--muted);font-size:12px">${l.companhia || 'â€”'}</td>
            <td class="hide-sm" style="color:var(--muted);font-size:12px">${l.cidade ? l.cidade + (l.estado ? ' â€” ' + l.estado : '') : 'â€”'}</td>
            <td><span class="badge badge-${l.status === 'convertido' ? 'convertido' : 'novo'}">${l.status || 'novo'}</span></td>
            <td class="hide-sm" style="color:var(--muted);font-size:12px">${date}</td>
            <td><button style="background:none;border:none;color:var(--blue);font-size:11px;font-weight:700;cursor:pointer">Ver â†’</button></td>
          </tr>`
        }
      }).join('')

      renderPagination()
    }

    // â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPagination() {
      const total = Math.ceil(filtered.length / PER_PAGE)
      const el    = document.getElementById('pagination')
      if (total <= 1) { el.innerHTML = ''; return }

      let html = ''
      if (currentPage > 1) html += `<button class="page-btn" onclick="goPage(${currentPage-1})">â†</button>`
      for (let i = 1; i <= total; i++) {
        if (i === 1 || i === total || Math.abs(i - currentPage) <= 2) {
          html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`
        } else if (Math.abs(i - currentPage) === 3) {
          html += `<span style="color:var(--dim);padding:0 4px">â€¦</span>`
        }
      }
      if (currentPage < total) html += `<button class="page-btn" onclick="goPage(${currentPage+1})">â†’</button>`
      el.innerHTML = html
    }

    function goPage(p) { currentPage = p; renderTable() }

    // â”€â”€ Modais â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openModal(lead) {
      const score = lead.score || 0
      const barColor = score >= 80 ? '#ef4444' : score >= 60 ? '#f59e0b' : '#3b82f6'
      document.getElementById('modalTitle').textContent = lead.nome || 'Lead'
      document.getElementById('modalBody').innerHTML = `
        <div class="modal-field">
          <div class="modal-field-label">Categoria / Score</div>
          <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
            <span class="badge badge-${lead.categoria || 'cold'}">${lead.categoria?.toUpperCase() || 'COLD'}</span>
            <div class="score-bar-wrap" style="flex:1">
              <div class="score-bar"><div class="score-fill" style="width:${score}%;background:${barColor}"></div></div>
              <span class="score-num" style="color:${barColor}">${score}</span>
            </div>
          </div>
        </div>
        ${field('E-mail', lead.email)}
        ${field('WhatsApp', lead.telefone ? `<a href="https://wa.me/55${lead.telefone.replace(/\D/g,'')}" target="_blank" style="color:var(--brand)">${lead.telefone}</a>` : 'â€”', true)}
        ${field('LocalizaÃ§Ã£o', lead.cidade ? `${lead.cidade} â€” ${lead.estado || ''}` : 'â€”')}
        ${field('Capital disponÃ­vel', lead.capital_disponivel ? 'R$ ' + Number(lead.capital_disponivel).toLocaleString('pt-BR') : 'â€”')}
        ${field('Marca', (lead.marcas?.emoji || '') + ' ' + (lead.marcas?.nome || 'â€”'))}
        ${field('Fonte', lead.fonte || 'â€”')}
        ${field('Status', lead.status || 'novo')}
        ${lead.mensagem_original ? field('Mensagem', lead.mensagem_original) : ''}
        ${field('Criado em', new Date(lead.created_at).toLocaleString('pt-BR'))}
      `
      document.getElementById('modalOverlay').classList.add('open')
    }

    function openModalSistema(lead) {
      document.getElementById('modalTitle').textContent = lead.nome || 'Prospect'
      document.getElementById('modalBody').innerHTML = `
        <div style="margin-bottom:16px">
          <span class="badge badge-sistema">ğŸš€ LeadCapture Pro</span>
        </div>
        ${field('E-mail', lead.email ? `<a href="mailto:${lead.email}" style="color:var(--blue)">${lead.email}</a>` : 'â€”', true)}
        ${field('WhatsApp', lead.telefone ? `<a href="https://wa.me/55${lead.telefone.replace(/\D/g,'')}" target="_blank" style="color:var(--brand)">${lead.telefone}</a>` : 'â€”', true)}
        ${field('Empresa', lead.companhia || 'â€”')}
        ${field('LocalizaÃ§Ã£o', lead.cidade ? `${lead.cidade} â€” ${lead.estado || ''}` : 'â€”')}
        ${field('ObservaÃ§Ã£o', lead.observacao || 'â€”')}
        ${field('Status', lead.status || 'novo')}
        ${field('Criado em', new Date(lead.created_at).toLocaleString('pt-BR'))}
      `
      document.getElementById('modalOverlay').classList.add('open')
    }

    function field(label, value, raw = false) {
      return `<div class="modal-field">
        <div class="modal-field-label">${label}</div>
        <div class="modal-field-value">${raw ? value : (value || 'â€”')}</div>
      </div>`
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('open')
    }

    // â”€â”€ Export CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function exportCSV() {
      const source = currentTab === 'produto' ? filtered : allSistema
      if (!source.length) return alert('Sem dados para exportar.')

      const cols  = currentTab === 'produto'
        ? ['Data','Nome','Email','Telefone','Score','Categoria','Marca','Status']
        : ['Data','Nome','Email','Telefone','Empresa','Cidade','Estado','ObservaÃ§Ã£o','Status']

      const rows = source.map(l => currentTab === 'produto'
        ? [new Date(l.created_at).toLocaleDateString('pt-BR'), l.nome, l.email, l.telefone, l.score, l.categoria, l.marcas?.nome, l.status]
        : [new Date(l.created_at).toLocaleDateString('pt-BR'), l.nome, l.email, l.telefone, l.companhia, l.cidade, l.estado, l.observacao, l.status]
      )

      const csv = [cols, ...rows].map(r => r.map(v => `"${v || ''}"`).join(',')).join('\n')
      const a   = document.createElement('a')
      a.href     = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv)
      a.download = `leadcapture-${currentTab}-${new Date().toISOString().split('T')[0]}.csv`
      a.click()
    }

    // â”€â”€ Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('searchInput').addEventListener('input',    () => { currentPage = 1; renderTable() })
    document.getElementById('categoriaFilter').addEventListener('change',() => { currentPage = 1; renderTable() })
    document.getElementById('marcaFilter').addEventListener('change',   () => { currentPage = 1; renderTable() })
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal() })

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadAll()
  </script>
</body>
</html>
