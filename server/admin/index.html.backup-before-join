<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Admin Panel - LeadCapture Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
  <div class="min-h-screen p-6">
    <!-- Header -->
    <div class="mb-8 bg-gradient-to-r from-orange-600 to-red-600 rounded-lg p-6">
      <h1 class="text-3xl font-bold">‚ö° Painel Administrativo</h1>
      <p class="text-orange-100">Raio de leads - Vis√£o geral do sistema multi-tenant</p>
    </div>

    <!-- Filters -->
    <div class="mb-6 bg-gray-800 rounded-lg p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="text" id="searchInput" placeholder="üîç Buscar por nome, email..." 
               class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
        
        <select id="tenantFilter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
          <option value="">üè¢ Todas as marcas</option>
        </select>

        <input type="number" id="scoreMin" placeholder="Score m√≠nimo" min="0" max="100"
               class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">

        <button id="exportBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
          üì• Export CSV
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-4">
        <div class="text-blue-200 text-sm">Total de Leads</div>
        <div id="totalLeads" class="text-3xl font-bold">0</div>
      </div>
      <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-4">
        <div class="text-green-200 text-sm">Hoje</div>
        <div id="todayLeads" class="text-3xl font-bold">0</div>
      </div>
      <div class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-4">
        <div class="text-purple-200 text-sm">Score M√©dio</div>
        <div id="avgScore" class="text-3xl font-bold">0</div>
      </div>
      <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg p-4">
        <div class="text-orange-200 text-sm">Marcas Ativas</div>
        <div id="activeTenants" class="text-3xl font-bold">0</div>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-gray-800 rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Data</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Marca</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Nome</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Email</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Telefone</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Score</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
            </tr>
          </thead>
          <tbody id="leadsTable" class="divide-y divide-gray-700">
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                <div class="animate-pulse">Carregando leads...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="pagination" class="mt-6 flex justify-center gap-2"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://krcybmownrpfjvqhacup.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyY3libW93bnJwZmp2cWhhY3VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNTM0MDgsImV4cCI6MjA4NDcyOTQwOH0.Y5D_dWds6XmJuhy0oxPwkgSmbq4BGS3sKB0OlHahP_c'
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

    let allLeads = []
    let filteredLeads = []
    let currentPage = 1
    const leadsPerPage = 20

    async function loadLeads() {
      try {
        const { data, error } = await supabaseClient
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false })

        if (error) throw error

        allLeads = data || []
        filteredLeads = allLeads
        
        updateStats()
        populateTenantFilter()
        renderLeads()
      } catch (error) {
        console.error('Erro:', error)
        document.getElementById('leadsTable').innerHTML = `
          <tr><td colspan="7" class="px-4 py-8 text-center text-red-400">
            ‚ùå Erro: ${error.message}
          </td></tr>
        `
      }
    }

    function updateStats() {
      const today = new Date().toISOString().split('T')[0]
      const todayLeads = allLeads.filter(l => l.created_at?.startsWith(today))
      const scores = allLeads.filter(l => l.score).map(l => l.score)
      const avgScore = scores.length ? (scores.reduce((a,b) => a+b, 0) / scores.length).toFixed(0) : 0
      const tenants = [...new Set(allLeads.map(l => l.tenant))]

      document.getElementById('totalLeads').textContent = allLeads.length
      document.getElementById('todayLeads').textContent = todayLeads.length
      document.getElementById('avgScore').textContent = avgScore
      document.getElementById('activeTenants').textContent = tenants.length
    }

    function populateTenantFilter() {
      const tenants = [...new Set(allLeads.map(l => l.tenant))].sort()
      const select = document.getElementById('tenantFilter')
      select.innerHTML = '<option value="">üè¢ Todas as marcas</option>'
      
      tenants.forEach(tenant => {
        const option = document.createElement('option')
        option.value = tenant
        option.textContent = tenant
        select.appendChild(option)
      })
    }

    function renderLeads() {
      const start = (currentPage - 1) * leadsPerPage
      const end = start + leadsPerPage
      const pageLeads = filteredLeads.slice(start, end)
      const tbody = document.getElementById('leadsTable')
      
      if (pageLeads.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">Nenhum lead encontrado</td></tr>`
        return
      }

      tbody.innerHTML = pageLeads.map(lead => {
        const date = new Date(lead.created_at).toLocaleDateString('pt-BR')
        const score = lead.score || 0
        const scoreColor = score >= 80 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'
        
        return `
          <tr class="hover:bg-gray-700">
            <td class="px-4 py-3 text-sm text-gray-300">${date}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 bg-orange-600 rounded text-xs font-semibold">${lead.tenant || 'N/A'}</span>
            </td>
            <td class="px-4 py-3 text-sm text-white">${lead.nome || 'N/A'}</td>
            <td class="px-4 py-3 text-sm text-gray-300">${lead.email || 'N/A'}</td>
            <td class="px-4 py-3 text-sm text-gray-300">${lead.telefone || 'N/A'}</td>
            <td class="px-4 py-3 text-sm font-bold ${scoreColor}">${score}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 ${lead.status === 'converted' ? 'bg-green-600' : 'bg-blue-600'} rounded text-xs">
                ${lead.status || 'new'}
              </span>
            </td>
          </tr>
        `
      }).join('')

      renderPagination()
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredLeads.length / leadsPerPage)
      const pagination = document.getElementById('pagination')
      
      if (totalPages <= 1) {
        pagination.innerHTML = ''
        return
      }

      let html = ''
      for (let i = 1; i <= totalPages; i++) {
        html += `
          <button onclick="goToPage(${i})" 
                  class="px-4 py-2 ${i === currentPage ? 'bg-orange-600' : 'bg-gray-700'} rounded hover:bg-orange-500">
            ${i}
          </button>
        `
      }
      pagination.innerHTML = html
    }

    function goToPage(page) {
      currentPage = page
      renderLeads()
    }

    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase()
      const tenant = document.getElementById('tenantFilter').value
      const scoreMin = parseInt(document.getElementById('scoreMin').value) || 0

      filteredLeads = allLeads.filter(lead => {
        const matchSearch = !search || 
          lead.nome?.toLowerCase().includes(search) ||
          lead.email?.toLowerCase().includes(search)
        const matchTenant = !tenant || lead.tenant === tenant
        const matchScore = (lead.score || 0) >= scoreMin
        return matchSearch && matchTenant && matchScore
      })

      currentPage = 1
      renderLeads()
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters)
    document.getElementById('tenantFilter').addEventListener('change', applyFilters)
    document.getElementById('scoreMin').addEventListener('input', applyFilters)

    document.getElementById('exportBtn').addEventListener('click', () => {
      const csv = [
        ['Data', 'Marca', 'Nome', 'Email', 'Telefone', 'Score', 'Status'],
        ...filteredLeads.map(l => [
          new Date(l.created_at).toLocaleDateString('pt-BR'),
          l.tenant || '', l.nome || '', l.email || '', l.telefone || '',
          l.score || 0, l.status || 'new'
        ])
      ].map(row => row.join(',')).join('\n')

      const blob = new Blob([csv], { type: 'text/csv' })
      const link = document.createElement('a')
      link.href = URL.createObjectURL(blob)
      link.download = `leads_${new Date().toISOString().split('T')[0]}.csv`
      link.click()
    })

    loadLeads()
    setInterval(loadLeads, 30000)
  </script>
</body>
</html>
