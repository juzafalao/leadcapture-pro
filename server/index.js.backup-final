import express from 'express'
import cors from 'cors'
import dotenv from 'dotenv'
import path from 'path'
import { fileURLToPath } from 'url'
import { createClient } from '@supabase/supabase-js'

// ConfiguraÃ§Ãµes ESM
const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// Carregar variÃ¡veis de ambiente
dotenv.config()

// Criar app Express
const app = express()

// Middlewares
app.use(cors())
app.use(express.json())
app.use(express.urlencoded({ extended: true }))

// Servir arquivos estÃ¡ticos
app.use(express.static(path.join(__dirname, 'public')))
app.use('/admin', express.static(path.join(__dirname, 'admin')))

// ============================================
// SUPABASE CONFIG
// ============================================
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
)

console.log('âœ… Supabase client inicializado')

// ============================================
// ROTAS
// ============================================

// Rota raiz
app.get('/', (req, res) => {
  res.send('LeadCapture Pro - Backend API')
})

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() })
})

// ============================================
// ROTA: RECEBER LEADS DA LANDING PAGE
// ============================================
app.post('/api/leads', async (req, res) => {
  try {
    console.log('ğŸ“¥ Recebendo lead da landing page...')
    console.log('Dados recebidos:', req.body)
    
    const leadData = req.body
    
    // ValidaÃ§Ã£o de campos obrigatÃ³rios
    if (!leadData.tenant_id) {
      return res.status(400).json({ 
        success: false, 
        error: 'tenant_id Ã© obrigatÃ³rio' 
      })
    }
    
    if (!leadData.nome || leadData.nome.trim().length < 3) {
      return res.status(400).json({ 
        success: false, 
        error: 'Nome completo Ã© obrigatÃ³rio (mÃ­nimo 3 caracteres)' 
      })
    }
    
    if (!leadData.email || !leadData.email.includes('@')) {
      return res.status(400).json({ 
        success: false, 
        error: 'Email vÃ¡lido Ã© obrigatÃ³rio' 
      })
    }
    
    if (!leadData.telefone || leadData.telefone.length < 10) {
      return res.status(400).json({ 
        success: false, 
        error: 'Telefone vÃ¡lido Ã© obrigatÃ³rio' 
      })
    }
    
    // Inserir no Supabase usando SERVICE_ROLE_KEY (seguro no backend)
    const { data, error } = await supabase
      .from('leads')
      .insert([leadData])
      .select()
    
    if (error) {
      console.error('âŒ Erro ao inserir no Supabase:', error)
      throw error
    }
    
    console.log('âœ… Lead salvo com sucesso:', data[0].id)
    
    res.json({ 
      success: true, 
      message: 'Lead recebido com sucesso!',
      leadId: data[0].id
    })
    
  } catch (error) {
    console.error('âŒ Erro ao processar lead:', error)
    res.status(500).json({ 
      success: false, 
      error: error.message || 'Erro ao salvar lead' 
    })
  }
})

// ============================================
// ROTA: LISTAR LEADS (para admin)
// ============================================
app.get('/api/leads', async (req, res) => {
  try {
    const { data, error } = await supabase
      .from('leads')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100)
    
    if (error) throw error
    
    res.json({ success: true, data })
    
  } catch (error) {
    console.error('âŒ Erro ao listar leads:', error)
    res.status(500).json({ success: false, error: error.message })
  }
})

// ============================================
// INICIAR SERVIDOR
// ============================================
const PORT = process.env.PORT || 4000

app.listen(PORT, () => {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ğŸš€ LeadCapture Pro - Backend')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log(`ğŸ“¡ Servidor rodando na porta ${PORT}`)
  console.log(`ğŸŒ Admin: http://localhost:${PORT}/admin`)
  console.log(`ğŸ§¼ Landing: http://localhost:${PORT}/dashboard/src/landing`)
  console.log(`ğŸ’š Health: http://localhost:${PORT}/health`)
  console.log(`ğŸ“Š API Leads: http://localhost:${PORT}/api/leads`)
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
})
